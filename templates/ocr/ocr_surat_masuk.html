{% extends "layouts/base.html" %} {% set page_title = "OCR Surat Masuk" %} {%
block head %} {{ super() }}

<!-- OCR Specific CSS -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='assets/css/ocr-modal-enhanced.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='assets/css/ocr-fullscreen.css') }}"
/>

<style>
  .ocr-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .drag-drop-area {
    transition: all 0.3s ease;
    border: 2px dashed #d1d5db;
  }

  .drag-drop-area.dragover {
    border-color: #3b82f6;
    background-color: #eff6ff;
  }

  @media (max-width: 768px) {
    .ocr-container {
      padding: 1rem;
    }
  }

  /* Ensure button is clickable */
  #viewExtractedDataBtn {
    position: relative !important;
    z-index: 9999 !important;
    cursor: pointer !important;
    pointer-events: auto !important;
    display: block !important;
    background-color: #22c55e !important;
    border: none !important;
    outline: none !important;
  }

  #viewExtractedDataBtn:hover {
    background-color: #16a34a !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
  }

  #viewExtractedDataBtn:active {
    transform: translateY(0);
    background-color: #15803d !important;
  }

  #viewExtractedDataBtn:focus {
    outline: 2px solid #22c55e !important;
    outline-offset: 2px !important;
  }

  /* Modern Modal Styling */
  #extractedDataModal {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
    animation: modalFadeIn 0.3s ease-out;
  }

  @keyframes modalFadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  #extractedDataModal.hidden {
    animation: modalFadeOut 0.2s ease-in;
  }

  @keyframes modalFadeOut {
    from {
      opacity: 1;
      transform: scale(1);
    }
    to {
      opacity: 0;
      transform: scale(0.95);
    }
  }

  /* Image container styling */
  #imagePreviewContainer {
    background: linear-gradient(45deg, #f8fafc 25%, transparent 25%),
      linear-gradient(-45deg, #f8fafc 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #f8fafc 75%),
      linear-gradient(-45deg, transparent 75%, #f8fafc 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
  }

  /* Enhanced input and textarea styling */
  input,
  textarea {
    transition: all 0.2s ease;
  }

  input:hover,
  textarea:hover {
    border-color: #94a3b8;
  }

  /* Textarea word wrapping */
  textarea {
    word-wrap: break-word;
    word-break: break-word;
    white-space: pre-wrap;
    line-height: 1.6;
    font-family: system-ui, -apple-system, sans-serif;
    overflow-wrap: break-word;
  }

  /* Custom scrollbar */
  .overflow-y-auto::-webkit-scrollbar {
    width: 6px;
  }

  .overflow-y-auto::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }

  .overflow-y-auto::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Fullscreen modal adjustments */
  #extractedDataModal .w-1\/2 {
    min-height: 0;
  }

  /* Responsive design */
  @media (max-width: 1024px) {
    #extractedDataModal .w-1\/2:first-child {
      width: 45% !important;
    }

    #extractedDataModal .w-1\/2:last-child {
      width: 55% !important;
    }
  }

  @media (max-width: 768px) {
    #extractedDataModal .flex {
      flex-direction: column !important;
    }

    #extractedDataModal .w-1\/2 {
      width: 100% !important;
      height: 50% !important;
    }

    #extractedDataModal .grid-cols-2 {
      grid-template-columns: 1fr !important;
    }

    #extractedDataModal .px-6 {
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }

    #extractedDataModal .py-4 {
      padding-top: 0.75rem !important;
      padding-bottom: 0.75rem !important;
    }
  }

  @media (max-width: 640px) {
    #extractedDataModal .p-2 {
      padding: 0.25rem !important;
    }

    #extractedDataModal .rounded-lg {
      border-radius: 0.375rem !important;
    }
  }

  /* Ensure proper height distribution */
  #extractedDataModal .flex.flex-1 {
    min-height: 0;
    flex: 1 1 0%;
  }

  /* Image container full height */
  #imagePreviewContainer {
    min-height: 300px;
  }

  @media (min-height: 600px) {
    #imagePreviewContainer {
      min-height: calc(100vh - 300px);
    }
  }
</style>
{% endblock %} {% block content %}
<div class="container mx-auto py-8 px-4">
  <div class="max-w-4xl mx-auto">
    <div class="form-card">
      <div class="page-header">
        <h2>
          <i class="fas fa-arrow-down text-green-400"></i>
          OCR Surat Masuk
        </h2>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div
      class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-100 border border-red-400 text-red-700{% elif category == 'success' %}bg-green-100 border border-green-400 text-green-700{% else %}bg-blue-100 border border-blue-400 text-blue-700{% endif %}"
    >
      {{ message }}
    </div>
    {% endfor %} {% endif %} {% endwith %}

    <h1 class="text-2xl font-bold mb-6 text-gray-800">OCR Surat Masuk</h1>

    <div class="bg-white rounded-lg shadow-md p-6">
      <form
        action="{{ url_for('ocr_surat_masuk.ocr_surat_masuk') }}"
        method="POST"
        enctype="multipart/form-data"
        class="space-y-6"
        id="uploadForm"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- File Upload Section -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Unggah Dokumen</label
            >
            <div
              id="dropzone"
              class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition"
            >
              <input
                type="file"
                name="image"
                id="fileInput"
                multiple
                accept="image/jpeg,image/png,image/webp"
                class="hidden"
                onchange="document.getElementById('selectedFiles').textContent = Array.from(this.files).map(f => f.name).join(', '); document.getElementById('filePreview').classList.remove('hidden');"
              />
              <div id="dropzoneText" class="text-gray-500">
                <p>Seret dan lepas dokumen di sini</p>
                <p class="mt-2">atau</p>
                <label
                  for="fileInput"
                  class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition inline-block cursor-pointer"
                >
                  Pilih Dokumen
                </label>
              </div>
              <div id="filePreview" class="mt-4 hidden">
                <p id="selectedFiles" class="text-sm text-gray-700"></p>
              </div>
            </div>
          </div>
          <!-- Informasi Tambahan -->
          <div>
            <h3 class="text-lg font-semibold mb-4">Petunjuk Unggah</h3>
            <ul class="list-disc list-inside text-sm text-gray-600 space-y-2">
              <li>Hanya dokumen gambar yang dapat diunggah</li>
              <li>Ukuran maksimal dokumen: 10 MB</li>
              <li>Format yang didukung: JPG, PNG, WEBP</li>
            </ul>
          </div>
        </div>

        <div class="flex justify-end">
          <button
            type="submit"
            class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition"
          >
            Proses Dokumen
          </button>
        </div>
      </form>
    </div>

    <!-- Static button for extracted data (will be shown if data exists) -->
    {% if extracted_data_list %}
    <div class="max-w-4xl mx-auto mt-4">
      <button
        id="viewExtractedDataBtn"
        class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition duration-300 font-medium text-lg shadow-lg w-full"
        type="button"
        style="
          position: relative;
          z-index: 9999;
          cursor: pointer;
          pointer-events: auto;
        "
      >
        <i class="fas fa-eye mr-2"></i>
        Lihat Hasil Ekstraksi ({{ extracted_data_list|length }} dokumen)
      </button>
    </div>
    {% endif %}

    <!-- Modal untuk Detail Ekstraksi -->
    {% if extracted_data_list %}
    <div
      id="extractedDataModal"
      class="fixed inset-0 z-50 hidden bg-black bg-opacity-30"
      aria-labelledby="modal-title"
      role="dialog"
      aria-modal="true"
    >
      <!-- Modal container -->
      <div class="w-full h-full p-2">
        <div
          class="bg-white rounded-lg shadow-2xl w-full h-full flex flex-col overflow-hidden"
        >
          <!-- Header -->
          <div
            class="bg-gradient-to-r from-slate-800 to-slate-900 px-4 md:px-6 py-3 md:py-4 flex items-center justify-between flex-shrink-0"
          >
            <div class="flex items-center">
              <div
                class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mr-4"
              >
                <i class="fas fa-file-text text-white text-xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-white" id="modal-title">
                  Detail Hasil Ekstraksi OCR
                </h3>
                <p class="text-slate-300 text-sm mt-1">
                  Surat Masuk - Dokumen Processing
                </p>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <button
                id="fullscreenToggleBtn"
                class="w-10 h-10 flex items-center justify-center text-white hover:bg-white hover:bg-opacity-20 rounded-lg transition-all duration-200"
                title="Toggle Fullscreen"
              >
                <i class="fas fa-expand text-sm"></i>
              </button>
              <button
                type="button"
                id="closeModalBtn"
                class="w-10 h-10 flex items-center justify-center text-white hover:bg-red-500 hover:bg-opacity-30 rounded-lg transition-all duration-200"
                onclick="closeExtractedDataModal()"
              >
                <i class="fas fa-times text-sm"></i>
              </button>
            </div>
          </div>

          <!-- Body -->
          <div class="flex flex-1 overflow-hidden">
            <!-- Left Panel - Image Preview -->
            <div
              class="w-1/2 bg-slate-50 border-r border-slate-200 flex flex-col"
            >
              <!-- Image Header -->
              <div
                class="px-4 md:px-6 py-3 md:py-4 bg-white border-b border-slate-200 flex-shrink-0"
              >
                <div class="flex items-center justify-between">
                  <h4
                    class="text-lg font-semibold text-slate-800 flex items-center"
                  >
                    <i class="fas fa-image mr-3 text-blue-500"></i>
                    Preview Dokumen
                  </h4>
                  <span
                    id="zoomLevel"
                    class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded-full"
                    >100%</span
                  >
                </div>
              </div>

              <!-- Image Controls -->
              <div
                class="px-4 md:px-6 py-2 md:py-3 bg-white border-b border-slate-200 flex-shrink-0"
              >
                <div class="flex items-center justify-center space-x-2">
                  <button
                    id="zoomOutBtn"
                    class="w-9 h-9 flex items-center justify-center text-slate-600 hover:text-white hover:bg-blue-500 rounded-lg transition-all duration-200"
                    title="Zoom Out"
                  >
                    <i class="fas fa-search-minus text-sm"></i>
                  </button>
                  <button
                    id="resetZoomBtn"
                    class="w-9 h-9 flex items-center justify-center text-slate-600 hover:text-white hover:bg-slate-500 rounded-lg transition-all duration-200"
                    title="Reset Zoom"
                  >
                    <i class="fas fa-undo text-sm"></i>
                  </button>
                  <button
                    id="zoomInBtn"
                    class="w-9 h-9 flex items-center justify-center text-slate-600 hover:text-white hover:bg-blue-500 rounded-lg transition-all duration-200"
                    title="Zoom In"
                  >
                    <i class="fas fa-search-plus text-sm"></i>
                  </button>
                  <div class="w-px h-6 bg-slate-300 mx-2"></div>
                  <button
                    id="rotateBtn"
                    class="w-9 h-9 flex items-center justify-center text-slate-600 hover:text-white hover:bg-purple-500 rounded-lg transition-all duration-200"
                    title="Rotate"
                  >
                    <i class="fas fa-sync text-sm"></i>
                  </button>
                </div>
              </div>

              <!-- Image Container -->
              <div class="flex-1 p-4 md:p-6 min-h-0">
                <div
                  id="imagePreviewContainer"
                  class="w-full h-full flex items-center justify-center border-2 border-dashed border-slate-300 rounded-xl overflow-hidden bg-white"
                >
                  <img
                    id="imagePreview"
                    src=""
                    alt="Preview Dokumen"
                    class="max-w-full max-h-full object-contain cursor-move transition-transform duration-200"
                  />
                  <div id="noImageText" class="text-center text-slate-400">
                    <i class="fas fa-image text-5xl mb-3 block opacity-50"></i>
                    <p class="text-lg font-medium">Tidak ada gambar</p>
                    <p class="text-sm mt-1 opacity-75">
                      Gambar akan muncul di sini
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Panel - Form -->
            <div class="w-1/2 bg-white flex flex-col">
              <!-- Form Header -->
              <div
                class="px-4 md:px-6 py-3 md:py-4 bg-white border-b border-slate-200 flex-shrink-0"
              >
                <h4
                  class="text-lg font-semibold text-slate-800 flex items-center"
                >
                  <i class="fas fa-edit mr-3 text-green-500"></i>
                  Data Ekstraksi
                </h4>
              </div>

              <!-- Form Content -->
              <div class="flex-1 overflow-y-auto p-4 md:p-6">
                <form id="extractedDataForm" class="space-y-4">
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />

                  <!-- Required Fields Section -->
                  <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                    <h5
                      class="text-sm font-bold text-blue-800 mb-3 flex items-center"
                    >
                      <i class="fas fa-asterisk mr-2 text-xs"></i>
                      Field Wajib
                    </h5>

                    <!-- Nomor Surat -->
                    <div class="mb-4">
                      <label
                        class="block text-sm font-semibold text-slate-700 mb-2"
                      >
                        Nomor Surat
                      </label>
                      <input
                        type="text"
                        name="full_letter_number"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-200"
                        placeholder="Masukkan nomor surat"
                      />
                    </div>

                    <!-- Tanggal -->
                    <div class="mb-4">
                      <label
                        class="block text-sm font-semibold text-slate-700 mb-2"
                      >
                        Tanggal
                      </label>
                      <input
                        type="date"
                        name="tanggal"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-200"
                      />
                    </div>

                    <!-- Pengirim -->
                    <div class="mb-4">
                      <label
                        class="block text-sm font-semibold text-slate-700 mb-2"
                      >
                        Pengirim
                      </label>
                      <input
                        type="text"
                        name="pengirim_suratMasuk"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-200"
                        placeholder="Nama pengirim"
                      />
                    </div>

                    <!-- Penerima -->
                    <div class="mb-4">
                      <label
                        class="block text-sm font-semibold text-slate-700 mb-2"
                      >
                        Penerima
                      </label>
                      <input
                        type="text"
                        name="penerima_suratMasuk"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-200"
                        placeholder="Nama penerima"
                      />
                    </div>

                    <!-- Isi Surat -->
                    <div>
                      <label
                        class="block text-sm font-semibold text-slate-700 mb-2"
                      >
                        Isi Surat
                      </label>
                      <textarea
                        name="isi_suratMasuk"
                        rows="4"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical text-sm leading-relaxed transition-all duration-200"
                        placeholder="Isi lengkap surat"
                      ></textarea>
                    </div>
                  </div>

                  <!-- Optional Fields Section -->
                  <div
                    class="bg-amber-50 rounded-xl p-4 border border-amber-200"
                  >
                    <h5
                      class="text-sm font-bold text-amber-800 mb-3 flex items-center"
                    >
                      <i class="fas fa-info-circle mr-2 text-xs"></i>
                      Informasi Acara (Opsional)
                    </h5>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <!-- Acara -->
                      <div>
                        <label
                          class="block text-sm font-semibold text-slate-600 mb-2"
                        >
                          Acara
                        </label>
                        <input
                          type="text"
                          name="acara_suratMasuk"
                          class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400 text-sm transition-all duration-200"
                          placeholder="Nama acara"
                        />
                      </div>

                      <!-- Tempat -->
                      <div>
                        <label
                          class="block text-sm font-semibold text-slate-600 mb-2"
                        >
                          Tempat
                        </label>
                        <input
                          type="text"
                          name="tempat_suratMasuk"
                          class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400 text-sm transition-all duration-200"
                          placeholder="Lokasi acara"
                        />
                      </div>

                      <!-- Tanggal Acara -->
                      <div>
                        <label
                          class="block text-sm font-semibold text-slate-600 mb-2"
                        >
                          Tanggal Acara
                        </label>
                        <input
                          type="date"
                          name="tanggal_acara_suratMasuk"
                          class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400 text-sm transition-all duration-200"
                        />
                      </div>

                      <!-- Jam Acara -->
                      <div>
                        <label
                          class="block text-sm font-semibold text-slate-600 mb-2"
                        >
                          Jam Acara
                        </label>
                        <input
                          type="time"
                          name="jam_suratMasuk"
                          class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400 text-sm transition-all duration-200"
                        />
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div
            class="bg-slate-50 border-t border-slate-200 px-4 md:px-6 py-3 md:py-4 flex-shrink-0"
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <button
                  type="button"
                  id="prevModalBtn"
                  class="inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 hover:border-blue-400 hover:text-blue-700 transition-all duration-200"
                >
                  <i class="fas fa-chevron-left mr-2 text-xs"></i>
                  Sebelumnya
                </button>
                <button
                  type="button"
                  id="nextModalBtn"
                  class="inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 hover:border-blue-400 hover:text-blue-700 transition-all duration-200"
                >
                  Selanjutnya
                  <i class="fas fa-chevron-right ml-2 text-xs"></i>
                </button>
                <div
                  class="flex items-center bg-blue-100 px-3 py-2 rounded-lg border border-blue-200"
                >
                  <i class="fas fa-file-alt mr-2 text-blue-600 text-sm"></i>
                  <span
                    id="currentDocCounter"
                    class="text-sm text-blue-800 font-semibold"
                    >Dokumen 1 dari {{ extracted_data_list|length }}</span
                  >
                </div>
              </div>
              <button
                type="button"
                id="saveExtractedData"
                class="inline-flex items-center px-6 py-2.5 text-sm font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200"
              >
                <i class="fas fa-save mr-2 text-sm"></i>
                Simpan Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endblock %} {% block scripts %}
  <!-- OCR Modal JavaScript - Using inline implementation instead of external file -->

  <script>
    // Make data available globally
    window.extractedDataList = {{ extracted_data_list | tojson | safe }};
    window.imagePaths = {{ image_paths | tojson | safe }};

    // Global function to open modal
    function openExtractedDataModal() {
        console.log('Opening modal...');
        console.log('Available extracted data:', window.extractedDataList);
        console.log('Available image paths:', window.imagePaths);

        const modal = document.getElementById('extractedDataModal');
        const extractedDataList = window.extractedDataList || [];

        if (!modal) {
            console.error('Modal not found!');
            alert('Modal tidak ditemukan. Silakan refresh halaman.');
            return;
        }

        modal.classList.remove('hidden');
        console.log('Modal opened');

        // Fill form with first extracted data
        if (extractedDataList.length > 0) {
            console.log('Filling form with first data item:', extractedDataList[0]);
            fillFormWithData(extractedDataList[0]);
        } else {
            console.log('No extracted data available');
        }
    }

    // Global function to close modal
    function closeExtractedDataModal() {
        const modal = document.getElementById('extractedDataModal');
        if (modal) {
            modal.classList.add('hidden');
            console.log('Modal closed');
        }
    }

    // Make functions globally available immediately
    window.openExtractedDataModal = openExtractedDataModal;
    window.closeExtractedDataModal = closeExtractedDataModal;

    // Function to fill form with extracted data
    function fillFormWithData(data) {
        const form = document.getElementById('extractedDataForm');
        if (!form || !data) return;

        const fieldMappings = {
            'full_letter_number': data['nomor_surat'] || '',
            'pengirim_suratMasuk': data['pengirim'] || '',
            'penerima_suratMasuk': data['penerima'] || '',
            'isi_suratMasuk': formatTextWithSpaces(data['isi'] || ''),
            'acara_suratMasuk': data['acara'] || '',
            'tempat_suratMasuk': data['tempat'] || '',
            'tanggal': data['tanggal'] || ''
        };

        Object.entries(fieldMappings).forEach(([name, value]) => {
            const input = form.querySelector(`[name="${name}"]`);
            if (input) {
                input.value = value;

                // Special handling for textarea to ensure proper display
                if (input.tagName.toLowerCase() === 'textarea') {
                    input.style.height = 'auto';
                    input.style.height = input.scrollHeight + 'px';
                }
            }
        });

        // Update image preview
        const imagePreview = document.getElementById('imagePreview');
        const noImageText = document.getElementById('noImageText');

        console.log('Updating image preview with data:', data);

        if (data && data.filename) {
            const imagePath = `/static/ocr/surat_masuk/${data.filename}`;
            console.log('Setting image path:', imagePath);

            imagePreview.src = imagePath;
            imagePreview.style.display = 'block';
            imagePreview.classList.remove('hidden');
            noImageText.style.display = 'none';
            noImageText.classList.add('hidden');

            // Handle image load error
            imagePreview.onerror = function() {
                console.error('Failed to load image:', imagePath);
                imagePreview.style.display = 'none';
                imagePreview.classList.add('hidden');
                noImageText.style.display = 'block';
                noImageText.classList.remove('hidden');
            };

            // Handle image load success
            imagePreview.onload = function() {
                console.log('Image loaded successfully:', imagePath);
            };
        } else {
            console.log('No filename in data, showing no image text');
            imagePreview.style.display = 'none';
            imagePreview.classList.add('hidden');
            noImageText.style.display = 'block';
            noImageText.classList.remove('hidden');
        }
    }

    // Function to format text with proper spacing for Indonesian text
    function formatTextWithSpaces(text) {
        if (!text) return '';

        // Check if text looks garbled or already has good spacing
        const words = text.split(/\s+/);
        const hasGarbledText = /[|(){}\[\]<>]/.test(text) || words.some(word => word.length < 2 && /[A-Z]/.test(word));
        const averageWordLength = words.reduce((sum, word) => sum + word.length, 0) / words.length;

        // If text looks garbled or already well-spaced, don't modify it
        if (hasGarbledText || averageWordLength < 8) {
            console.log('Text formatting: Skipping garbled or well-spaced text:', text.substring(0, 50) + '...');
            return text;
        }

        // Only apply conservative patterns for clear merged words
        const conservativePatterns = [
            // Only fix clear Indonesian word combinations with long merged words
            [/permohonan([a-z]{4,})/gi, 'permohonan $1'],
            [/sidang([a-z]{4,})/gi, 'sidang $1'],
            [/secara([a-z]{4,})/gi, 'secara $1'],
            [/dengan([a-z]{4,})/gi, 'dengan $1'],
            [/kepada([a-z]{4,})/gi, 'kepada $1'],
            [/untuk([a-z]{4,})/gi, 'untuk $1'],
            [/mohon([a-z]{4,})/gi, 'mohon $1'],
            [/surat([a-z]{4,})/gi, 'surat $1'],
            [/pengadilan([a-z]{4,})/gi, 'pengadilan $1'],

            // Only fix clear camelCase (lowercase followed by uppercase)
            [/([a-z]{3,})([A-Z][a-z]{3,})/g, '$1 $2']
        ];

        // Apply conservative patterns
        let improvedText = text;
        let hasChanges = false;

        conservativePatterns.forEach(([pattern, replacement]) => {
            const newText = improvedText.replace(pattern, replacement);
            if (newText !== improvedText) {
                hasChanges = true;
                improvedText = newText;
            }
        });

        // Only clean up if we actually made changes
        if (hasChanges) {
            improvedText = improvedText.replace(/\s+/g, ' ').trim();
            console.log('Text spacing improved:', {
                original: text,
                improved: improvedText
            });
            return improvedText;
        }

        return text;
    }

    // Make additional functions globally available
    window.fillFormWithData = fillFormWithData;
    window.formatTextWithSpaces = formatTextWithSpaces;

    // Test function for debugging
    function testButtonClick() {
        console.log('Test function called');
        const btn = document.getElementById('viewExtractedDataBtn');
        console.log('Button found:', btn);
        if (btn) {
            console.log('Button properties:', {
                visible: btn.offsetParent !== null,
                disabled: btn.disabled,
                style: getComputedStyle(btn).display,
                zIndex: getComputedStyle(btn).zIndex,
                pointerEvents: getComputedStyle(btn).pointerEvents
            });
        }
        openExtractedDataModal();
    }

    // Make test function globally available
    window.testButtonClick = testButtonClick;

    // Function to save extracted data to server
    function saveExtractedDataToServer() {
        console.log('Save function called');

        const form = document.getElementById('extractedDataForm');
        if (!form) {
            alert('Form tidak ditemukan');
            return;
        }

        // Get CSRF token from multiple possible sources
        let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                       document.querySelector('input[name="csrf_token"]')?.value ||
                       document.cookie.split('; ').find(row => row.startsWith('csrf_token='))?.split('=')[1];

        if (!csrfToken) {
            console.error('CSRF token not found in meta tag, form input, or cookie');
            alert('CSRF token tidak ditemukan. Silakan refresh halaman.');
            return;
        }

        console.log('Using CSRF token:', csrfToken.substring(0, 10) + '...');

        // Collect form data
        const formData = new FormData(form);
        const data = {};

        // Convert FormData to regular object
        for (let [key, value] of formData.entries()) {
            if (key !== 'csrf_token') {
                data[key] = value;
            }
        }

        // Add current document filename if available
        if (window.extractedDataList && window.extractedDataList[currentDocIndex]) {
            data.filename = window.extractedDataList[currentDocIndex].filename;
        }

        // Show loading state
        const saveBtn = document.getElementById('saveExtractedData');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';
        saveBtn.disabled = true;

        console.log('Sending data to server:', data);

        // Send data to server
        fetch('/surat-masuk/save_extracted_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-CSRF-Token': csrfToken // Try both header formats
            },
            body: JSON.stringify([data]) // Send as array to match server expectation
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                alert('Data berhasil disimpan!');
                // Optionally close modal or move to next document
                if (currentDocIndex < window.extractedDataList.length - 1) {
                    currentDocIndex++;
                    fillFormWithData(window.extractedDataList[currentDocIndex]);
                    updateDocumentCounter(currentDocIndex);
                } else {
                    closeExtractedDataModal();
                }
            } else {
                throw new Error(result.error || 'Gagal menyimpan data');
            }
        })
        .catch(error => {
            console.error('Error saving data:', error);
            alert('Terjadi kesalahan saat menyimpan data: ' + error.message);
        })
        .finally(() => {
            // Restore button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
    }

    // Make save function globally available
    window.saveExtractedDataToServer = saveExtractedDataToServer;

    // Test function to check endpoint connectivity
    function testSaveEndpoint() {
        console.log('Testing save endpoint...');

        fetch('/surat-masuk/test_endpoint', {
            method: 'GET'
        })
        .then(response => {
            console.log('Test endpoint response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            console.log('Test endpoint result:', result);
            alert('Endpoint test successful: ' + result.message);
        })
        .catch(error => {
            console.error('Test endpoint error:', error);
            alert('Endpoint test failed: ' + error.message);
        });
    }

    // Make test function globally available
    window.testSaveEndpoint = testSaveEndpoint;

    // Global variables for document navigation
    let currentDocIndex = 0;

    // Fullscreen toggle functionality (modal is already fullscreen by default)
    function toggleFullscreen() {
        const fullscreenBtn = document.getElementById('fullscreenToggleBtn');

        // Since modal is already fullscreen, this button can be used for browser fullscreen
        if (!document.fullscreenElement) {
            // Enter browser fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            }
            fullscreenBtn.innerHTML = '<i class="fas fa-compress text-sm"></i>';
            fullscreenBtn.title = 'Keluar dari Browser Fullscreen';
        } else {
            // Exit browser fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            fullscreenBtn.innerHTML = '<i class="fas fa-expand text-sm"></i>';
            fullscreenBtn.title = 'Masuk ke Browser Fullscreen';
        }
    }

    // Rotate image functionality
    function rotateImage() {
        const imagePreview = document.getElementById('imagePreview');
        if (!imagePreview) return;

        // Get current rotation
        const currentRotation = parseInt(imagePreview.dataset.rotation || '0');
        const newRotation = (currentRotation + 90) % 360;

        // Apply new rotation
        imagePreview.style.transform = `rotate(${newRotation}deg)`;
        imagePreview.dataset.rotation = newRotation;
    }

    // Update document counter
    function updateDocumentCounter(currentIndex) {
        const counter = document.getElementById('currentDocCounter');
        if (counter) {
            counter.textContent = `Dokumen ${currentIndex + 1} dari ${window.extractedDataList.length}`;
        }
    }

    // Handle fullscreen change events (for browser fullscreen API)
    function handleFullscreenChange() {
        const fullscreenBtn = document.getElementById('fullscreenToggleBtn');
        if (!fullscreenBtn) return;

        if (document.fullscreenElement) {
            fullscreenBtn.innerHTML = '<i class="fas fa-compress text-sm"></i>';
            fullscreenBtn.title = 'Keluar dari Browser Fullscreen';
        } else {
            fullscreenBtn.innerHTML = '<i class="fas fa-expand text-sm"></i>';
            fullscreenBtn.title = 'Masuk ke Browser Fullscreen';
        }
    }

    // DOM Content Loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, setting up handlers...');

        // Setup button click handler
        const viewBtn = document.getElementById('viewExtractedDataBtn');
        console.log('Looking for button:', viewBtn);

        if (viewBtn) {
            // Remove any existing event listeners
            viewBtn.onclick = null;

            // Add single event listener
            viewBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Button clicked!');

                currentDocIndex = 0; // Reset to first document
                openExtractedDataModal();

                setTimeout(() => {
                    updateDocumentCounter(0);
                }, 100);
            });

            console.log('Button handler set up successfully');

            // Test button immediately
            setTimeout(() => {
                console.log('Button test:', {
                    exists: !!viewBtn,
                    visible: viewBtn.offsetParent !== null,
                    disabled: viewBtn.disabled,
                    style: getComputedStyle(viewBtn).display
                });
            }, 100);
        } else {
            console.error('View button not found!');

            // Try to find button after delay
            setTimeout(() => {
                const delayedBtn = document.getElementById('viewExtractedDataBtn');
                console.log('Delayed button search:', delayedBtn);
                if (delayedBtn) {
                    delayedBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Delayed button clicked!');
                        openExtractedDataModal();
                    });
                }
            }, 500);
        }

        // Setup modal close handlers
        const closeBtn = document.getElementById('closeModalBtn');
        if (closeBtn) {
            closeBtn.onclick = closeExtractedDataModal;
        }

        const modal = document.getElementById('extractedDataModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeExtractedDataModal();
                }
            });
        }

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeExtractedDataModal();
            }
        });

        // Fullscreen toggle button
        const fullscreenBtn = document.getElementById('fullscreenToggleBtn');
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', toggleFullscreen);
        }

        // Rotate button
        const rotateBtn = document.getElementById('rotateBtn');
        if (rotateBtn) {
            rotateBtn.addEventListener('click', rotateImage);
        }

        // Handle fullscreen change events
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);

        // Navigation between documents
        const prevBtn = document.getElementById('prevModalBtn');
        const nextBtn = document.getElementById('nextModalBtn');

        if (prevBtn && nextBtn) {
            prevBtn.addEventListener('click', function() {
                if (currentDocIndex > 0) {
                    currentDocIndex--;
                    fillFormWithData(window.extractedDataList[currentDocIndex]);
                    updateDocumentCounter(currentDocIndex);
                }
            });

            nextBtn.addEventListener('click', function() {
                if (currentDocIndex < window.extractedDataList.length - 1) {
                    currentDocIndex++;
                    fillFormWithData(window.extractedDataList[currentDocIndex]);
                    updateDocumentCounter(currentDocIndex);
                }
            });
        }

        // Save extracted data functionality
        const saveBtn = document.getElementById('saveExtractedData');
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveExtractedDataToServer();
            });
        }

        // File upload functionality
        const fileInput = document.getElementById('fileInput');
        const selectedFilesText = document.getElementById('selectedFiles');
        const dropzone = document.getElementById('dropzone');

        // File input change handler
        if (fileInput && selectedFilesText) {
            fileInput.addEventListener('change', function() {
                updateFileDisplay(this.files);
            });
        }

        // Drag and drop functionality
        if (dropzone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });

            dropzone.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropzone.classList.add('border-blue-500', 'bg-blue-50');
        }

        function unhighlight(e) {
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (fileInput) {
                fileInput.files = files;
                updateFileDisplay(files);
            }
        }

        function updateFileDisplay(files) {
            if (!selectedFilesText) return;

            if (files.length > 0) {
                const fileNames = Array.from(files)
                    .map(file => file.name)
                    .join(', ');

                selectedFilesText.textContent = `Dipilih: ${fileNames}`;
                selectedFilesText.classList.remove('text-gray-600');
                selectedFilesText.classList.add('text-green-600');

                const filePreview = document.getElementById('filePreview');
                if (filePreview) {
                    filePreview.classList.remove('hidden');
                }
            } else {
                selectedFilesText.textContent = 'Belum ada file dipilih';
                selectedFilesText.classList.remove('text-green-600');
                selectedFilesText.classList.add('text-gray-600');
            }
        }
    });
  </script>
  {% endblock %}
</div>
