{% extends "layouts/base.html" %}

{% block content %}
<div class="container mt-5">
  <h2>Manajemen User</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card mb-4">
    <div class="card-header">
      <h4>Daftar Pengguna</h4>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.email }}</td>
              <td>{{ user.role }}</td>
              <td>
                {% if user.is_approved %}
                  <span class="badge bg-success">Approved</span>
                {% else %}
                  <span class="badge bg-warning">Pending</span>
                {% endif %}
              </td>
              <td>{{ user.last_login|default('Never', true) }}</td>
              <td>
                <div class="btn-group">
                  {% if not user.is_approved %}
                  <form method="POST" action="/approve-user/{{ user.id }}">
                    <button type="submit" class="btn btn-sm btn-success">Approve</button>
                  </form>
                  {% endif %}
                  <button class="btn btn-sm btn-primary ml-2" onclick="selectUser({{ user.id }}, '{{ user.email }}')">Edit</button>
                  <form method="POST" action="/delete-user/{{ user.id }}" onsubmit="return confirm('Are you sure you want to delete this user?');" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-danger ml-2">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h4>Edit User</h4>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('edit_user_view') }}">
        <!-- Select User -->
        <div class="form-group mb-3">
          <label for="userSelect">Select User:</label>
          <select class="form-control" id="userSelect" name="user_id" required>
            <option value="">-- Choose User --</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.email }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Email Field -->
        <div class="form-group mb-3">
          <label for="email">Email:</label>
          <input type="text" class="form-control" name="email" id="email" required />
        </div>

        <!-- Role Field -->
        <div class="form-group mb-3">
          <label for="role">Role:</label>
          <select class="form-control" name="role" id="role" required>
            <option value="karyawan">Karyawan</option>
            <option value="pimpinan">Pimpinan</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <!-- Status Field -->
        <div class="form-group mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_approved" id="is_approved" value="1">
            <label class="form-check-label" for="is_approved">
              Approved
            </label>
          </div>
        </div>

        <!-- Password Field -->
        <div class="form-group mb-3">
          <label for="password">New Password:</label>
          <input type="password" class="form-control" name="password" id="password" />
          <small class="form-text text-muted">Leave empty to keep current password</small>
        </div>

        <button type="submit" class="btn btn-primary">Update User</button>
      </form>
    </div>
  </div>
</div>

<script>
  function selectUser(userId, email) {
    document.getElementById("userSelect").value = userId;
    fetchUserData(userId);
  }

  async function fetchUserData(userId) {
    if (!userId) {
      document.getElementById("email").value = '';
      document.getElementById("password").value = '';
      document.getElementById("role").value = 'karyawan';
      document.getElementById("is_approved").checked = false;
      return;
    }

    try {
      const response = await fetch(`/get-user-data/${userId}`);
      const data = await response.json();

      if (data.success) {
        document.getElementById("email").value = data.email;
        document.getElementById("role").value = data.role || 'karyawan';
        document.getElementById("is_approved").checked = data.is_approved;
        document.getElementById("password").value = '';
      } else {
        alert("User not found.");
      }
    } catch (error) {
      alert("Error fetching user data.");
      console.error(error);
    }
  }
</script>
{% endblock %}
